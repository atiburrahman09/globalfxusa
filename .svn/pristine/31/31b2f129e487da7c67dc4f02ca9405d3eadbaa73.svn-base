using System;
using System.Data;
using System.Web.UI;
using Global.Core.BLL;
using Lumex.Tech;

using System.Web.UI.WebControls;
using System.Web;
using System.IO;
namespace globalfx.setting.User
{
    public partial class create : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                msgbox.Visible = false;

                if (!IsPostBack)
                {
                    LoadUserGroups();
                    // GetBranch();

                }

            }
            catch (Exception ex)
            {

                string message = ex.Message;
                if (ex.InnerException != null) { message += " --> " + ex.InnerException.Message; }
                MyAlertBox("ErrorAlert(\"" + ex.GetType() + "\", \"" + message + "\", \"\");");
            }
        }
        //private void GetBranch()
        //{
        //    DataTable dt = new DataTable();
        //    BranchBLL branchBll = new BranchBLL();
        //    try
        //    {

        //        dt = branchBll.GetBranchList();
        //        if (dt.Rows.Count > 0)
        //        {
        //            BranchDropDownList.DataSource = dt;
        //            BranchDropDownList.DataValueField = "BranchId";
        //            BranchDropDownList.DataTextField = "Name";


        //            BranchDropDownList.DataBind();

        //            BranchDropDownList.Items.Insert(0, "----------Select----------");
        //            //    BranchDropDownList.SelectedIndex = 0;
        //            BranchDropDownList.SelectedValue = (string)LumexSessionManager.Get("UserBranchId");


        //        }
        //        dt.Clear();

        //    }
        //    catch (Exception ex)
        //    {

        //        string message = ex.Message;
        //        if (ex.InnerException != null) { message += " --> " + ex.InnerException.Message; }
        //        MyAlertBox("ErrorAlert(\"" + ex.GetType() + "\", \"" + message + "\", \"\");");
        //    }
        //}

        private void LoadUserGroups()
        {

            try
            {

                UserGroupBLL usergroupbll = new UserGroupBLL();
                DataTable dt = usergroupbll.GetActiveUserGroupList();
                drpdownGroup.DataTextField = "UserGroupName";
                drpdownGroup.DataValueField = "UserGroupId";
                drpdownGroup.DataSource = dt;
                drpdownGroup.DataBind();
                drpdownGroup.Items.Insert(0, "Select Group");
                drpdownGroup.SelectedIndex = 0;
                drpdownGroup.Items[0].Value = "";

            }
            catch (Exception ex)
            {

                string message = ex.Message;
                if (ex.InnerException != null) { message += " --> " + ex.InnerException.Message; }
                MyAlertBox("ErrorAlert(\"" + ex.GetType() + "\", \"" + message + "\", \"\");");

            }

        }

        protected void txtbxEmailTextchanged(object sender, EventArgs e)
        {
            bool st = checkDuplicateUser();

        }
        private bool checkDuplicateUser()
        {
            bool isExits = false;
            try
            {
                UserBLL userbll = new UserBLL();
                if (userbll.CheckDuplicateUser(txtbxemail.Text))
                {
                    msgbox.Attributes.Add("Class", "alert alert-warning");
                    msgTitleLabel.Text = "Error!!";
                    msgDetailLabel.Text = "Email address alredy exits!!!";
                    msgbox.Visible = true;
                    isExits = true;

                }

            }
            catch (Exception ex)
            {

                string message = ex.Message;
                if (ex.InnerException != null) { message += " --> " + ex.InnerException.Message; }
                MyAlertBox("ErrorAlert(\"" + ex.GetType() + "\", \"" + message + "\", \"\");");

            }
            return isExits;
        }
        protected void btnUserCreate_click(object sender, EventArgs e)
        {
            try
            {
                if (!checkDuplicateUser())
                {

                    UserBLL userbll = new UserBLL();

                    userbll.UserName = txtbxUserName.Text;
                    userbll.Cell = "+88" + txtbxmobile.Text;
                    userbll.Email = txtbxemail.Text;
                    //userbll.DOB = txtbxDateOfBirth.Text;
                    //userbll.Gender = drpdwnSex.Text;
                    userbll.UserGroupId = drpdownGroup.SelectedValue;
                    userbll.Certificate = "";
                    userbll.Password = passwordTextBox.Text;
                    //userbll.Occupation = drpdwnOccupation.SelectedValue;
                    //userbll.Organization = txtbxNameofOrganization.Text;
                    //userbll.Designation = txtbxDesignation.Text;
                    //userbll.ExperienceICT = txtbxExperienceICT.Text;
                    //userbll.LastDegree = drpdwnLastEducation.SelectedValue;
                    //userbll.DegreeSubject = txtbxsubject.Text;
                    //userbll.PassingYear = txtbxYear.Text;

                    //userbll.FatherName = txtbxFatherName.Text;
                    //userbll.MotherName = txtbxMotherName.Text;
                    //userbll.ParmanentAdd = txtbxParmanentAddress.Text;
                    //userbll.PresentAdd = txtbxPresentAddress.Text;
                    //userbll.Branch = BranchDropDownList.SelectedValue;

                    string IsUpload = photoUploadfn(userbll.Email);


                    if (IsUpload == "")
                    {
                        msgbox.Attributes.Add("Class", "alert alert-warning");
                        msgTitleLabel.Text = "Error!!!!";
                        msgDetailLabel.Text = "Pleace Check File Extention or File size.You can only upload Image and size less than 128Kb";
                        msgbox.Visible = true;
                        string message = " <span class='actionTopic'>" + " Pleace Check File Extention or File size.You can only upload Image and size less than 128Kb</span>.";
                        MyAlertBox("var callbackOk = function () { window.location = \"/setting/user/create.aspx\"; }; SuccessAlert(\"" + "Process Succeed" + "\", \"" + message + "\", callbackOk);");
                    }
                    else
                    {
                        AutoIdGenerateBLL autoid = new AutoIdGenerateBLL();
                        DataTable dt = autoid.CreateId("U");
                        userbll.UserId = dt.Rows[0][0].ToString();

                        userbll.PerPhoto = IsUpload;
                        DataTable status = userbll.SaveUser();
                        if (status.Rows.Count > 0)
                        {
                            autoid.updateId("U");
                            autoid.deleteId(userbll.UserId);

                            //bool st = SendConformationEmail(userbll);
                            //if (st)
                            //{

                            string message = " <span class='actionTopic'>" + "User Create Successfully</span>.";
                            MyAlertBox("var callbackOk = function () { window.location = \"/setting/user/list.aspx\"; }; SuccessAlert(\"" + "Process Succeed" + "\", \"" + message + "\", callbackOk);");
                        }
                        //else
                        //{
                        //    string message = " <span class='actionTopic'>" + "User Create Successfully.But Not Send Please Contact Your Admistration.</span>.";
                        //    MyAlertBox("var callbackOk = function () { window.location = \"/setting/user/list.aspx\"; }; SuccessAlert(\"" + "Process Succeed" + "\", \"" + message + "\", callbackOk);");
                        //}
                        //  }

                        //    }





                        //}

                    }
                }
            }
            catch (Exception ex)
            {

                string message = ex.Message;
                if (ex.InnerException != null) { message += " --> " + ex.InnerException.Message; }
                MyAlertBox("ErrorAlert(\"" + ex.GetType() + "\", \"" + message + "\", \"\");");

            }

        }
        //private bool SendConformationEmail(UserBLL userBll)
        //{
        //    bool mailSend = false;
        //    try
        //    {
        //        Random random = new Random();
        //        userBll.varifycode = random.Next(100000, 999998) + 1;
        //        string key = lumexEncryptbll.addforvarifycore;
        //        string encrypeteduid = lumexEncryptbll.EncryptRijndael(userBll.UserId + "#" + userBll.varifycode, key);
        //        string url = HttpContext.Current.Request.Url.AbsoluteUri;
        //        string[] Partsofurl = url.Split('/');
        //        userBll.ActivationUrl = Server.HtmlEncode("http://" + Partsofurl[2] + "/varify/?uid=" + encrypeteduid);


        //        MailContactBLL mail = new MailContactBLL();
        //        mailSend = mail.sendemailtocompleteResigtration(userBll);


        //    }
        //    catch (Exception ex)
        //    {
        //        string message = ex.Message;
        //        if (ex.InnerException != null) { message += " --> " + ex.InnerException.Message; }
        //        MyAlertBox("ErrorAlert(\"" + ex.GetType() + "\", \"" + message + "\", \"\");");

        //    }
        //    return mailSend;
        //}

        private string photoUploadfn(string userId)
        {
            string result = "";
            try
            {


                FileUpload FilePP = new FileUpload();
                FilePP = fileupload;
                if (FilePP.HasFile && FilePP.PostedFile.ContentLength <= 131072)
                {

                    string getExtention = Path.GetExtension(FilePP.FileName);

                    if (getExtention == ".jpg" || getExtention == ".jpeg" || getExtention == ".png" || getExtention == ".gif")
                    {

                        // hidFileName.Value = filename;
                        // string path = HttpContext.Current.Server.MapPath(WebConfigurationManager.AppSettings["AttachmentPath"] + "/ModuleContents/");
                        string loc = "/UsersContents/" + userId + "/";
                        string path = HttpContext.Current.Server.MapPath(loc);
                        if (!Directory.Exists(path))
                        {
                            Directory.CreateDirectory(path);
                        }

                        path = path + "profilephoto" + getExtention;

                        FilePP.PostedFile.SaveAs(path);
                        result = "profilephoto" + getExtention;

                    }


                }




            }
            catch (Exception)
            {

                throw;
            }

            return result;
        }
        protected void MyAlertBox(string alertScript)
        {
            ScriptManager.RegisterStartupScript(this, this.GetType(), "ServerControlScript", alertScript, true);
        }
    }
}